#!/usr/bin/env bash

# Re-apply custom configs after Omarchy upgrade

set -euo pipefail

DOTFILES="${HOME}/.dotfiles"

# Remove packages that upstream migrations may have reinstalled
omarchy-pkg-drop \
  aether \
  typora \
  spotify \
  libreoffice-fresh \
  1password-beta \
  1password-cli \
  xournalpp \
  signal-desktop \
  pinta \
  obsidian \
  obs-studio \
  kdenlive \
  lazydocker \
  asdcontrol \
  clang \
  dotnet-runtime-9.0 \
  dust \
  fcitx5 \
  fcitx5-gtk \
  fcitx5-qt \
  github-cli \
  lazygit \
  llvm \
  luarocks \
  mariadb-libs \
  opencode \
  postgresql-libs \
  python-poetry-core \
  ruby \
  slurp \
  tldr \
  tree-sitter-cli \
  wayfreeze \
  whois \
  zoxide

# Remove Omarchy defaults that conflict with stowed dotfiles
rm -f "${HOME}/.config/opencode/opencode.json"
rm -rf "${HOME}/.config/ghostty"
rm -rf "${HOME}/.config/git"
rm -f "${HOME}/.config/starship.toml"

# Re-stow dotfiles and re-apply theme
stow --restow --dir="${DOTFILES}/omarchy" --target="${HOME}/.config" config
stow --restow --dir="${DOTFILES}/share" --target="${HOME}/.config" config
current_theme="$(basename "$(readlink "${HOME}/.config/theme/current")" 2>/dev/null || echo rosepine)"
bash "${DOTFILES}/share/bin/theme-switch" "${current_theme}"

bash "${DOTFILES}/omarchy/install/install-hypr-overrides.sh"
