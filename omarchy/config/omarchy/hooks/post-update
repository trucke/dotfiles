#!/usr/bin/env bash

# Re-apply custom configs after Omarchy upgrade

set -euo pipefail

DOTFILES="${HOME}/.dotfiles"

# Remove packages that upstream migrations may have reinstalled
while IFS= read -r pkg; do
  pacman -Qi "${pkg}" &>/dev/null && yay -Rnsu --noconfirm "${pkg}" &>/dev/null || true
done < "${DOTFILES}/omarchy/install/cleanup.packages"

# Remove Omarchy defaults that conflict with stowed dotfiles
rm -f "${HOME}/.config/opencode/opencode.json"
rm -rf "${HOME}/.config/ghostty"
rm -rf "${HOME}/.config/git"
rm -f "${HOME}/.config/starship.toml"

# Re-stow dotfiles and re-apply theme
stow --restow --dir="${DOTFILES}/omarchy" --target="${HOME}/.config" config
stow --restow --dir="${DOTFILES}/share" --target="${HOME}/.config" config
current_theme="$(basename "$(readlink "${HOME}/.config/theme/current")" 2>/dev/null || echo rosepine)"
bash "${DOTFILES}/share/bin/theme-switch" "${current_theme}"

bash "${DOTFILES}/omarchy/install/install-hypr-overrides.sh"
