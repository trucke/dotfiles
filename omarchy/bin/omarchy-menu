#!/bin/bash

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

back_to() {
    local parent_menu="$1"

    if [[ "$BACK_TO_EXIT" == "true" ]]; then
        exit 0
    elif [[ -n "$parent_menu" ]]; then
        "$parent_menu"
    else
        show_main_menu
    fi
}

menu() {
    local prompt="$1"
    local options="$2"
    local extra="$3"
    local preselect="$4"

    read -r -a args <<<"$extra"

    if [[ -n "$preselect" ]]; then
        local index
        index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
        if [[ -n "$index" ]]; then
            args+=("-c" "$index")
        fi
    fi

    echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 600 -p "$prompt…" "${args[@]}" 2>/dev/null
}

terminal() {
    # xdg-terminal-exec --title=Omarchy -e "$@"
    xdg-terminal-exec --app-id=com.omarchy.Omarchy "$@"
}

present_terminal() {
    omarchy-launch-floating-terminal-with-presentation $1
}

show_share_menu() {
    case $(menu "Share" "  Clipboard\n  File \n  Folder") in
    *Clipboard*) terminal bash -c "omarchy-cmd-share clipboard" ;;
    *File*) terminal bash -c "omarchy-cmd-share file" ;;
    *Folder*) terminal bash -c "omarchy-cmd-share folder" ;;
    *) back_to show_main_menu ;;
    esac
}

show_font_menu() {
    theme=$(menu "Font" "$(omarchy-font-list)" "--width 350" "$(omarchy-font-current)")
    if [[ "$theme" == "CNCLD" || -z "$theme" ]]; then
        back_to show_main_menu
    else
        omarchy-font-set "$theme"
    fi
}

show_setup_menu() {
    local options="󱐋  Power Profile\n󰱔  DNS\n󰈷  Fingerprint\n  Fido2"
    case $(menu "Setup" "$options") in
    *Power*) show_setup_power_menu ;;
    *DNS*) present_terminal omarchy-setup-dns ;;
    *Fingerprint*) present_terminal omarchy-setup-fingerprint ;;
    *Fido2*) present_terminal omarchy-setup-fido2 ;;
    *) show_main_menu ;;
    esac
}

show_setup_power_menu() {
    profile=$(menu "Power Profile" "$(omarchy-powerprofiles-list)" "" "$(powerprofilesctl get)")

    if [[ "$profile" == "CNCLD" || -z "$profile" ]]; then
        back_to show_setup_menu
    else
        powerprofilesctl set "$profile"
    fi
}

show_install_menu() {
    case $(menu "Install" "  Web App\n  TUI\n󰵮  Development\n󰍲  Windows\n  Gaming") in
    *Web*) present_terminal omarchy-webapp-install ;;
    *TUI*) present_terminal omarchy-tui-install ;;
    *Development*) show_install_development_menu ;;
    *Windows*) present_terminal "omarchy-windows-vm install" ;;
    *) show_main_menu ;;
    esac
}

show_install_development_menu() {
    case $(menu "Install" "󰫏  Ruby on Rails\n  Docker DB\n  JavaScript\n  Go\n  Python\n  Elixir\n  Zig\n  Java\n  .NET") in
    *Rails*) present_terminal "omarchy-install-dev-env ruby" ;;
    *Docker*) present_terminal omarchy-install-docker-dbs ;;
    *JavaScript*) show_install_javascript_menu ;;
    *Go*) present_terminal "omarchy-install-dev-env go" ;;
    *Python*) present_terminal "omarchy-install-dev-env python" ;;
    *Elixir*) show_install_elixir_menu ;;
    *Zig*) present_terminal "omarchy-install-dev-env zig" ;;
    *Java*) present_terminal "omarchy-install-dev-env java" ;;
    *NET*) present_terminal "omarchy-install-dev-env dotnet" ;;
    *) show_install_menu ;;
    esac
}

show_install_javascript_menu() {
    case $(menu "Install" "  Node.js\n  Bun\n  Deno") in
    *Node*) present_terminal "omarchy-install-dev-env node" ;;
    *Bun*) present_terminal "omarchy-install-dev-env bun" ;;
    *Deno*) present_terminal "omarchy-install-dev-env deno" ;;
    *) show_install_development_menu ;;
    esac
}

show_install_elixir_menu() {
    case $(menu "Install" "  Elixir\n  Phoenix") in
    *Elixir*) present_terminal "omarchy-install-dev-env elixir" ;;
    *Phoenix*) present_terminal "omarchy-install-dev-env phoenix" ;;
    *) show_install_development_menu ;;
    esac
}

show_remove_menu() {
    case $(menu "Remove" "  Fido2\n󰈷  Fingerprint\n  TUI\n  Web App\n󰍲  Windows") in
    *Fido2*) present_terminal "omarchy-setup-fido2 --remove" ;;
    *Fingerprint*) present_terminal "omarchy-setup-fingerprint --remove" ;;
    *TUI*) present_terminal omarchy-tui-remove ;;
    *Web*) present_terminal omarchy-webapp-remove ;;
    *Windows*) present_terminal "omarchy-windows-vm remove" ;;
    *) show_main_menu ;;
    esac
}

show_update_menu() {
  case $(menu "Update" "  Firmware\n  Password\n  Timezone\n  Time") in
  *Firmware*) present_terminal omarchy-update-firmware ;;
  *Timezone*) present_terminal omarchy-tz-select ;;
  *Time*) present_terminal omarchy-update-time ;;
  *Password*) show_update_password_menu ;;
  *) show_main_menu ;;
  esac
}

show_update_password_menu() {
    case $(menu "Update Password" "  Drive Encryption\n  User") in
    *Drive*) present_terminal omarchy-drive-set-password ;;
    *User*) present_terminal passwd ;;
    *) show_update_menu ;;
    esac
}

show_system_menu() {
    case $(menu "System" "  Lock\n󰤄  Suspend\n󰜉  Restart\n󰐥  Shutdown") in
    *Lock*) omarchy-lock-screen ;;
    *Suspend*) systemctl suspend ;;
    *Restart*) omarchy-state clear re*-required && systemctl reboot --no-wall ;;
    *Shutdown*) omarchy-state clear re*-required && systemctl poweroff --no-wall ;;
    *) back_to show_main_menu ;;
    esac
}

show_main_menu() {
    go_to_menu "$(menu "Go" "󰉉  Install\n  Font\n󰭌  Remove\n  Setup\n  Share\n  System\n  Update")"
}

go_to_menu() {
    case "${1,,}" in
    *install*) show_install_menu ;;
    *font*) show_font_menu ;;
    *password*) show_update_password_menu ;;
    *remove*) show_remove_menu ;;
    *setup*) show_setup_menu ;;
    *share*) show_share_menu ;;
    *system*) show_system_menu ;;
    *update*) show_update_menu ;;
    esac
}

if [[ -n "$1" ]]; then
    BACK_TO_EXIT=true
    go_to_menu "$1"
else
    show_main_menu
fi
