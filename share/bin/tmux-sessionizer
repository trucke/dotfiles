#!/usr/bin/env bash

SEARCH_PATHS=(~/ ~/development ~/development/heylogix ~/development/classio ~/development/roomvibes ~/development/raycast/)

show_help() {
    echo "Usage: $0 <session-name>"
    echo
    echo "Create a new tmux session with 3 windows."
    echo "Window 1: default shell"
    echo "Window 2: runs 'nvim .'"
    echo "Window 3: runs 'opencode .'"
    echo
    echo "If no session name is provided, select one interactively from directories"
    echo "under the search paths: ${SEARCH_PATHS[*]}"
    echo
    echo "Options:"
    echo "  -h, --help    Show this help message and exit"
}

sanity_check() {
    for cmd in tmux fzf fd; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            echo "Error: Required command '$cmd' not found. Please install it."
            exit 1
        fi
    done
}

find_dirs_or_sessions() {
    sessions=$(tmux list-sessions -F "[TMUX] #{session_name}" 2>/dev/null) || sessions=""
    if [[ -n "${TMUX}" && -n "$sessions" ]]; then
        current_session=$(tmux display-message -p '#S')
        echo "$sessions" | grep -vFx "[TMUX] $current_session"
    else
        echo "$sessions"
    fi

    for p in "${SEARCH_PATHS[@]}"; do
        path="$(eval echo "$p")"
        [[ -d "$path" ]] && fd -H --type d --min-depth 1 --max-depth 1 . "${path}"
    done
}

is_tmux_running() {
    [[ -n $TMUX ]] || pgrep tmux >/dev/null 2>&1
}

has_session() {
    tmux has-session -t "$1" 2>/dev/null
}

switch_to() {
    if [[ -z $TMUX ]]; then
        tmux attach-session -t "$1"
    else
        tmux switch-client -t "$1"
    fi
}

sanity_check
case "$1" in
-h | --help)
    show_help
    exit 0
    ;;
"")
    selected=$(find_dirs_or_sessions | fzf)
    [[ -z "$selected" ]] && exit 0
    if [[ "$selected" =~ ^\[TMUX\]\ (.+)$ ]]; then
        selected="${BASH_REMATCH[1]}"
    fi
    session_name=$(basename "$selected" | tr . _)
    ;;
*)
    session_name="$1"
    selected="$(pwd)"
    ;;
esac

# if ! is_tmux_running || ! has_session "$session_name"; then
#     tmux new-session -d -s "$session_name" -c "$selected"
#     tmux new-window -d -t "$session_name:2" -c "$selected" "nvim ."
#     tmux new-window -d -t "$session_name:3" -c "$selected" "opencode ."
# fi

if ! tmux has-session -t "$session_name" 2>/dev/null; then
    # Window 1: opencode as base, then build layout from it
    tmux new-session -d -s "$session_name" -n "opencode" -c "$selected" "opencode"
    # Window 2: left + right panes, right one runs nvim
    tmux new-window -t "$session_name:2" -c "$selected"
    tmux new-window -t "$session_name:69" -n "looping" -c "$selected"
fi

switch_to "$session_name:1"
